import java.io.*;
import java.net.*;
import java.util.Base64;
import java.util.Random;

public class UDPserver {
    private static final int MIN_PORT = 50000;
    private static final int MAX_PORT = 51000;
    private static final int BUFFER_SIZE = 1024;

    public static void main(String[] args) {
        if (args.length != 1) {
            System.err.println("Usage: java UDPserver <port>");
            System.exit(1);
        }

        int serverPort = Integer.parseInt(args[0]);
        DatagramSocket socket = null;

        try {
            // 创建主服务器套接字
            socket = new DatagramSocket(serverPort);
            System.out.println("Server started on port " + serverPort);

            byte[] buffer = new byte[BUFFER_SIZE];
            while (true) {
                DatagramPacket packet = new DatagramPacket(buffer, buffer.length);
                socket.receive(packet);
                String request = new String(packet.getData(), 0, packet.getLength()).trim();

                if (request.startsWith("DOWNLOAD")) {
                    String filename = request.substring(8).trim();
                    System.out.println("Received download request for: " + filename);

                    int dataPort = allocatePort();
                    new FileHandlerThread(socket, packet.getAddress(), packet.getPort(), filename, dataPort).start();

                    String response = "OK " + filename + " SIZE " + getFileSize(filename) + " PORT " + dataPort;
                    byte[] responseBytes = response.getBytes();
                    DatagramPacket responsePacket = new DatagramPacket(
                        responseBytes, responseBytes.length, packet.getAddress(), packet.getPort());
                    socket.send(responsePacket);
                }
            }
        } catch (IOException e) {
            System.err.println("Server error: " + e.getMessage());
            e.printStackTrace();
        } finally {
            if (socket != null) socket.close();
        }
    }

     private static int allocatePort() {
        Random random = new Random();
        return MIN_PORT + random.nextInt(MAX_PORT - MIN_PORT + 1);
    }
